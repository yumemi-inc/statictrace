<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://unpkg.com/d3-dag@0.6.0"></script>
  </head>
  <body>
    <script>
      const data = [
        {
          id: "0",
          parentIds: ["8"],
        },
        {
          id: "1",
          parentIds: [],
        },
        {
          id: "2",
          parentIds: [],
        },
        {
          id: "3",
          parentIds: ["11"],
        },
        {
          id: "4",
          parentIds: ["12"],
        },
        {
          id: "5",
          parentIds: ["18"],
        },
        {
          id: "6",
          parentIds: ["9", "15", "17"],
        },
        {
          id: "7",
          parentIds: ["3", "17", "20", "21"],
        },
        {
          id: "8",
          parentIds: [],
        },
        {
          id: "9",
          parentIds: ["4"],
        },
        {
          id: "10",
          parentIds: ["16", "21"],
        },
        {
          id: "11",
          parentIds: ["2"],
        },
        {
          id: "12",
          parentIds: ["21"],
        },
        {
          id: "13",
          parentIds: ["4", "12"],
        },
        {
          id: "14",
          parentIds: ["1", "8"],
        },
        {
          id: "15",
          parentIds: [],
        },
        {
          id: "16",
          parentIds: ["0"],
        },
        {
          id: "17",
          parentIds: ["19"],
        },
        {
          id: "18",
          parentIds: ["9"],
        },
        {
          id: "19",
          parentIds: [],
        },
        {
          id: "20",
          parentIds: ["13"],
        },
        {
          id: "21",
          parentIds: [],
        },
      ];

      var dag = d3.dagStratify()(data);

      const layout = d3
        .sugiyama()
        .nodeSize([60, 60])
        .layering(d3.layeringCoffmanGraham())
        .decross(d3.decrossTwoLayer().order(d3.twolayerOpt()))
        .coord(d3.coordGreedy())
        .nodeSize(() => [20 * 2 * 1.5, 20 * 2 * 1.5]);

      const { width, height } = layout(dag);

      // This code only handles rendering
      const svgSelection = d3.select("body").append("svg");

      svgSelection.attr("width", width);
      svgSelection.attr("height", height);

      const defs = svgSelection.append("defs"); // For gradients

      const steps = dag.size();
      const interp = d3.interpolateRainbow;
      const colorMap = {};
      for (const [i, node] of dag.idescendants().entries()) {
        colorMap[node.data.id] = interp(i / steps);
      }

      // How to draw edges
      const line = d3
        .line()
        .curve(d3.curveCatmullRom)
        .x((d) => d.x)
        .y((d) => d.y);

      // Plot edges
      svgSelection
        .append("g")
        .selectAll("path")
        .data(dag.links())
        .enter()
        .append("path")
        .attr("d", ({ points }) => line(points))
        .attr("fill", "none")
        .attr("stroke-width", 3)
        .attr("stroke", ({ source, target }) => {
          // encodeURIComponents for spaces, hope id doesn't have a `--` in it
          const gradId = encodeURIComponent(
            `${source.data.id}--${target.data.id}`
          );
          const grad = defs
            .append("linearGradient")
            .attr("id", gradId)
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", source.x)
            .attr("x2", target.x)
            .attr("y1", source.y)
            .attr("y2", target.y);
          grad
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", colorMap[source.data.id]);
          grad
            .append("stop")
            .attr("offset", "100%")
            .attr("stop-color", colorMap[target.data.id]);
          return `url(#${gradId})`;
        });

      // Select nodes
      const nodes = svgSelection
        .append("g")
        .selectAll("g")
        .data(dag.descendants())
        .enter()
        .append("g")
        .attr("transform", ({ x, y }) => `translate(${x}, ${y})`);

      // Plot node circles
      nodes
        .append("circle")
        .attr("r", 20)
        .attr("fill", (n) => colorMap[n.data.id]);

      // Add text to nodes
      nodes
        .append("text")
        .text((d) => d.data.id)
        .attr("font-weight", "bold")
        .attr("font-family", "sans-serif")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("fill", "white");

      const body = document.querySelector("body");
    </script>
  </body>
</html>
